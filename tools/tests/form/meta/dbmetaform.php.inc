<?php

$this->isFalse(empty($oDb), sprintf(_WT('The file %s requires a database object $oDb in the current scope before it is included.'), __FILE__));

if (!class_exists('myDbMetaFormSetScaffold')) {
	class myDbMetaFormSetScaffoldRef extends weeDbSetScaffold
	{
		protected $sTableName = 'dbmetaformref';
	}

	class myDbMetaFormSetScaffold extends weeDbSetScaffold
	{
		protected $aRefSets = array('myDbMetaFormSetScaffoldRef');
		protected $sTableName = 'dbmetaform';
	}
}

$oDb->query('BEGIN');
$oDb->query('CREATE TABLE dbmetaformref (ref_id integer, ref_label varchar(50), PRIMARY KEY (ref_id))');
$oDb->query('CREATE TABLE dbmetaform (dmf_id integer, dmf_number integer, dmf_text text, ref_id integer, PRIMARY KEY (dmf_id))');

$oDb->query("INSERT INTO dbmetaformref VALUES (1, 'app')");
$oDb->query("INSERT INTO dbmetaformref VALUES (2, 'pub')");
$oDb->query("INSERT INTO dbmetaformref VALUES (3, 'res')");
$oDb->query("INSERT INTO dbmetaformref VALUES (4, 'tools')");
$oDb->query("INSERT INTO dbmetaformref VALUES (5, 'wee')");

$oSet = new myDbMetaFormSetScaffold;
$oSet->setDb($oDb);

try {
	$oForm = new weeDbMetaForm($oSet, array('formkey' => false));
	$oForm->xml()->uri = '';

	$sExpectedForm = '<form action="" class="block" method="post"><ol><li><fieldset><ol><li><label for="form_dmf_number">dmf_number</label> <input type="text" id="form_dmf_number" name="dmf_number"/></li><li><label for="form_dmf_text">dmf_text</label> <input type="text" id="form_dmf_text" name="dmf_text"/></li><li><label for="form_ref_id">ref_id</label> <select id="form_ref_id" name="ref_id"><option value="">NULL</option><option value="1">app</option><option value="2">pub</option><option value="3">res</option><option value="4">tools</option><option value="5">wee</option></select></li><li><fieldset class="buttonsfieldset"><ol><li><input type="submit"/></li></ol></fieldset></li></ol></fieldset></li></ol></form>' . "\n";
	$this->isEqual($sExpectedForm, $oForm->toString(),
		_WT('The form generated by weeDbMetaForm is different than expected.'));

	$this->isIdentical(array('ref_id' => null, 'dmf_number' => '12', 'dmf_text' => array(1, 3, 5, '')),
		$oForm->filter(array('ref_id' => '', 'dmf_number' => '12', 'dmf_text' => array(1, 3, 5, ''), 'unknown_value' => 'the sleeper has overslept')),
		_WT('weeDbMetaForm::filter does not convert correctly empty strings to NULL.'));

} catch (Exception $oException) {
}

$oDb->query('DROP TABLE dbmetaformref');
$oDb->query('DROP TABLE dbmetaform');
$oDb->query('ROLLBACK');

if (!empty($oException))
	throw $oException;
